<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codnite Authentication Debug - Senior Developer Analysis</title>
    <style>
        body { font-family: 'Consolas', 'Monaco', monospace; margin: 20px; background: #0d1117; color: #f0f6fc; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #30363d; border-radius: 8px; background: #161b22; }
        .success { background: #0d4429; border: 1px solid #238636; }
        .error { background: #490202; border: 1px solid #da3633; }
        .warning { background: #5c4d00; border: 1px solid #d29922; }
        .info { background: #0c2d6b; border: 1px solid #1f6feb; }
        .debug { background: #21262d; border: 1px solid #30363d; font-family: monospace; font-size: 12px; padding: 15px; border-radius: 4px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        button { background: #238636; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2ea043; }
        button.danger { background: #da3633; }
        button.danger:hover { background: #f85149; }
        button.warning { background: #d29922; }
        button.warning:hover { background: #e3b341; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #0d4429; border: 1px solid #238636; }
        .status.error { background: #490202; border: 1px solid #da3633; }
        .status.warning { background: #5c4d00; border: 1px solid #d29922; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 3px; font-size: 11px; }
        .log-entry.info { background: #0c2d6b; }
        .log-entry.success { background: #0d4429; }
        .log-entry.error { background: #490202; }
        .log-entry.warning { background: #5c4d00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Codnite Authentication Debug - Senior Developer Analysis</h1>
        
        <div class="section success">
            <h2>‚úÖ Authentication Flow Fixes Applied</h2>
            <div class="status success">
                <strong>1. CORS Issue Fixed:</strong> Backend now properly allows localhost:5173<br>
                <strong>2. Authentication State Management:</strong> Improved with dependency array fix<br>
                <strong>3. Debug Logging Enhanced:</strong> Comprehensive emoji-based logging system<br>
                <strong>4. Race Condition Prevention:</strong> Added authentication state checks<br>
                <strong>5. Default Form Changed:</strong> App now shows LOGIN form by default
            </div>
        </div>
        
        <div class="section info">
            <h2>üîç Debug Analysis - What Was Fixed</h2>
            <div class="grid">
                <div>
                    <h3>üö® Original Issues:</h3>
                    <ul>
                        <li>CORS errors blocking API requests</li>
                        <li>Registration form shown by default</li>
                        <li>Race condition in authentication check</li>
                        <li>Missing dependency in useEffect</li>
                        <li>Insufficient debug logging</li>
                    </ul>
                </div>
                <div>
                    <h3>‚úÖ Solutions Applied:</h3>
                    <ul>
                        <li>Enhanced CORS configuration</li>
                        <li>Login form as default</li>
                        <li>Fixed useEffect dependencies</li>
                        <li>Added authentication state guards</li>
                        <li>Comprehensive debug logging</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="section warning">
            <h2>üß™ Test Instructions</h2>
            <div class="status warning">
                <strong>Step 1:</strong> Open Codnite app at <a href="http://localhost:5173" target="_blank" style="color: #58a6ff;">http://localhost:5173</a><br><br>
                <strong>Step 2:</strong> You should see LOGIN form (not registration)<br><br>
                <strong>Step 3:</strong> Use test credentials:<br>
                ‚Ä¢ <strong>Email:</strong> shadan@example.com<br>
                ‚Ä¢ <strong>Password:</strong> Shadan700@#<br><br>
                <strong>Step 4:</strong> Watch console for detailed debug logs
            </div>
        </div>
        
        <div class="section">
            <h2>üîç Console Log Analysis</h2>
            <div class="debug" id="consoleLogs">Waiting for console logs...</div>
        </div>
        
        <div class="section">
            <h2>üìä Authentication State Monitor</h2>
            <div class="debug" id="authState">Loading authentication state...</div>
        </div>
        
        <div class="section">
            <h2>üõ†Ô∏è Debug Tools</h2>
            <button onclick="openMainApp()">Open Codnite App</button>
            <button onclick="clearStorage()" class="danger">Clear All Storage</button>
            <button onclick="testAPI()" class="warning">Test API Directly</button>
            <button onclick="simulateLogin()" class="info">Simulate Login Flow</button>
            <button onclick="checkAuthFlow()" class="warning">Check Auth Flow</button>
        </div>
        
        <div class="section error">
            <h2>üö® If Still Not Working</h2>
            <div class="status error">
                <strong>Advanced Debugging Steps:</strong><br><br>
                1. <strong>Check Network Tab:</strong> Look for failed requests<br>
                2. <strong>Check Console:</strong> Look for error messages<br>
                3. <strong>Check localStorage:</strong> Verify token storage<br>
                4. <strong>Check React DevTools:</strong> Monitor state changes<br>
                5. <strong>Try Incognito:</strong> Test in private browsing<br><br>
                <strong>Share Debug Info:</strong> Copy console logs and share
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let logEntries = [];
        
        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logEntries.push({ timestamp, message, type });
            updateConsoleLogs();
        }
        
        function updateConsoleLogs() {
            const logsDiv = document.getElementById('consoleLogs');
            logsDiv.innerHTML = logEntries.map(entry => 
                `<div class="log-entry ${entry.type}">[${entry.timestamp}] ${entry.message}</div>`
            ).join('');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function updateAuthState() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let state = 'Authentication State Monitor:\n\n';
            state += `Backend Status: ${API_BASE}/health\n`;
            state += `Token: ${token ? 'EXISTS (' + token.substring(0, 30) + '...)' : 'NONE'}\n`;
            state += `User: ${user ? 'EXISTS' : 'NONE'}\n`;
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    state += `User Name: ${userData.name}\n`;
                    state += `User Email: ${userData.email}\n`;
                    state += `User ID: ${userData.id}\n`;
                } catch (e) {
                    state += `User Parse Error: ${e.message}\n`;
                }
            }
            
            state += `\nCurrent Time: ${new Date().toLocaleString()}\n`;
            state += `App URL: http://localhost:5173\n`;
            state += `API URL: ${API_BASE}\n`;
            
            document.getElementById('authState').innerHTML = state;
        }
        
        function openMainApp() {
            addLogEntry('Opening Codnite app in new tab', 'info');
            window.open('http://localhost:5173', '_blank');
        }
        
        function clearStorage() {
            addLogEntry('Clearing all browser storage', 'warning');
            localStorage.clear();
            sessionStorage.clear();
            updateAuthState();
            addLogEntry('Storage cleared successfully', 'success');
        }
        
        async function testAPI() {
            try {
                addLogEntry('Testing API health endpoint', 'info');
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.text();
                addLogEntry(`API Test: ${response.status} - ${data}`, 'success');
            } catch (error) {
                addLogEntry(`API Test Failed: ${error.message}`, 'error');
            }
        }
        
        async function simulateLogin() {
            try {
                addLogEntry('Simulating login flow', 'info');
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'shadan@example.com',
                        password: 'Shadan700@#'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addLogEntry('Login simulation successful', 'success');
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    updateAuthState();
                } else {
                    addLogEntry(`Login simulation failed: ${data.error}`, 'error');
                }
            } catch (error) {
                addLogEntry(`Login simulation error: ${error.message}`, 'error');
            }
        }
        
        async function checkAuthFlow() {
            try {
                addLogEntry('Checking authentication flow', 'info');
                const token = localStorage.getItem('token');
                
                if (!token) {
                    addLogEntry('No token found - user not authenticated', 'warning');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    addLogEntry('Auth check successful - user is authenticated', 'success');
                    updateAuthState();
                } else {
                    addLogEntry('Auth check failed - token invalid', 'error');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    updateAuthState();
                }
            } catch (error) {
                addLogEntry(`Auth check error: ${error.message}`, 'error');
            }
        }
        
        // Initial setup
        addLogEntry('Authentication debug tool initialized', 'success');
        updateAuthState();
        
        // Monitor localStorage changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'token' || e.key === 'user') {
                addLogEntry(`localStorage changed: ${e.key}`, 'info');
                updateAuthState();
            }
        });
        
        // Update auth state every 2 seconds
        setInterval(updateAuthState, 2000);
        
        // Monitor console logs (if possible)
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && typeof args[0] === 'string') {
                addLogEntry(args[0], 'info');
            }
        };
    </script>
</body>
</html>
