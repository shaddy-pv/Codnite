<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Authentication Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
        .success { background: #155724; border: 1px solid #c3e6cb; }
        .error { background: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .debug { background: #333; border: 1px solid #666; font-family: monospace; font-size: 12px; padding: 15px; border-radius: 4px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #555; border-radius: 4px; background: #333; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Authentication Debug Test</h1>
        
        <div class="section info">
            <h2>🧪 Direct Login Test</h2>
            <div class="info">
                <p>This will test the login API directly and simulate what should happen in the app:</p>
                
                <input type="email" id="email" placeholder="Email" value="shadan@example.com">
                <input type="password" id="password" placeholder="Password" value="Shadan700@#">
                <button onclick="testDirectLogin()">Test Direct Login</button>
                <button onclick="simulateAppLogin()">Simulate App Login Flow</button>
            </div>
        </div>
        
        <div class="section">
            <h2>📊 Test Results</h2>
            <div class="debug" id="testResults">Waiting for test results...</div>
        </div>
        
        <div class="section">
            <h2>🔍 Current State</h2>
            <div class="debug" id="currentState">Loading current state...</div>
        </div>
        
        <div class="section">
            <h2>🛠️ Debug Tools</h2>
            <button onclick="openMainApp()">Open Codnite App</button>
            <button onclick="clearStorage()">Clear Storage</button>
            <button onclick="checkConsole()">Check Console Logs</button>
            <button onclick="testAuthFlow()">Test Auth Flow</button>
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function updateCurrentState() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let state = 'Current State:\n\n';
            state += `Token: ${token ? 'EXISTS (' + token.substring(0, 30) + '...)' : 'NONE'}\n`;
            state += `User: ${user ? 'EXISTS' : 'NONE'}\n`;
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    state += `User Name: ${userData.name}\n`;
                    state += `User Email: ${userData.email}\n`;
                } catch (e) {
                    state += `User Parse Error: ${e.message}\n`;
                }
            }
            
            state += `\nCurrent Time: ${new Date().toLocaleString()}\n`;
            
            document.getElementById('currentState').innerHTML = state;
        }
        
        async function testDirectLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            addResult(`🔐 Testing direct login with: ${email}`);
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                addResult(`📡 Response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`✅ Login successful!`);
                    addResult(`User: ${data.user.name} (${data.user.email})`);
                    addResult(`Token: ${data.token.substring(0, 30)}...`);
                    
                    // Store the data
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    addResult(`💾 Data stored in localStorage`);
                    updateCurrentState();
                } else {
                    const error = await response.json();
                    addResult(`❌ Login failed: ${error.error}`);
                }
            } catch (error) {
                addResult(`💥 Error: ${error.message}`);
            }
        }
        
        async function simulateAppLogin() {
            addResult(`🎭 Simulating app login flow...`);
            
            // Step 1: Check if we have stored data
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                addResult(`❌ No stored data found. Run direct login first.`);
                return;
            }
            
            addResult(`✅ Found stored data`);
            
            // Step 2: Simulate what the app should do
            try {
                const response = await fetch('http://localhost:5000/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                
                addResult(`📡 Auth check response: ${response.status}`);
                
                if (response.ok) {
                    const userData = await response.json();
                    addResult(`✅ Auth check successful`);
                    addResult(`User: ${userData.name} (${userData.email})`);
                    
                    // This is what should happen in the app
                    addResult(`🎯 App should now show main dashboard`);
                    addResult(`🎯 isAuthenticated should be true`);
                    addResult(`🎯 User should be set in state`);
                } else {
                    addResult(`❌ Auth check failed - token invalid`);
                }
            } catch (error) {
                addResult(`💥 Auth check error: ${error.message}`);
            }
        }
        
        function openMainApp() {
            addResult(`🚀 Opening Codnite app...`);
            window.open('http://localhost:5173', '_blank');
        }
        
        function clearStorage() {
            addResult(`🗑️ Clearing storage...`);
            localStorage.clear();
            sessionStorage.clear();
            updateCurrentState();
            addResult(`✅ Storage cleared`);
        }
        
        function checkConsole() {
            addResult(`🔍 Check the browser console for detailed logs`);
            addResult(`Look for messages starting with emojis like 🔍, 🚀, ✅, etc.`);
        }
        
        function testAuthFlow() {
            addResult(`🧪 Testing complete auth flow...`);
            
            // Check current state
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                addResult(`✅ User is already authenticated`);
                addResult(`App should show main dashboard`);
                addResult(`If app shows login form, there's a frontend issue`);
            } else {
                addResult(`❌ User not authenticated`);
                addResult(`App should show login form`);
            }
        }
        
        // Initial setup
        addResult(`🔧 Authentication debug tool initialized`);
        updateCurrentState();
        
        // Update state every 2 seconds
        setInterval(updateCurrentState, 2000);
    </script>
</body>
</html>
