<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codnite Notification System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .notification {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .notification.unread {
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .notification.high {
            border-left: 4px solid #dc3545;
        }
        .notification.medium {
            border-left: 4px solid #ffc107;
        }
        .notification.low {
            border-left: 4px solid #28a745;
        }
        .preferences {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #007bff;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîî Codnite Notification System Test</h1>
    
    <div class="container">
        <h2>Authentication</h2>
        <div id="authStatus" class="status info">Not authenticated</div>
        <button class="button" onclick="login()">Login</button>
        <button class="button" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <h2>Socket.IO Connection</h2>
        <div id="socketStatus" class="status info">Not connected</div>
        <button class="button" onclick="connectSocket()">Connect</button>
        <button class="button" onclick="disconnectSocket()">Disconnect</button>
    </div>

    <div class="container">
        <h2>Test Notifications</h2>
        <div class="button-group">
            <button class="button" onclick="sendTestNotification('follow', 'New Follower', 'Someone started following you')">Follow</button>
            <button class="button" onclick="sendTestNotification('like', 'Post Liked', 'Someone liked your post')">Like</button>
            <button class="button" onclick="sendTestNotification('comment', 'New Comment', 'Someone commented on your post')">Comment</button>
            <button class="button" onclick="sendTestNotification('problem', 'Problem Accepted', 'Your submission was accepted')">Problem</button>
            <button class="button" onclick="sendTestNotification('achievement', 'New Achievement', 'You earned a new achievement!')">Achievement</button>
            <button class="button" onclick="sendTestNotification('system', 'System Announcement', 'Important system update')">System</button>
        </div>
        <button class="button" onclick="sendBulkNotifications(5)">Send 5 Bulk Notifications</button>
    </div>

    <div class="container">
        <h2>Notification Preferences</h2>
        <div id="preferences"></div>
        <button class="button" onclick="loadPreferences()">Load Preferences</button>
        <button class="button" onclick="savePreferences()">Save Preferences</button>
    </div>

    <div class="container">
        <h2>Notifications</h2>
        <div id="unreadCount" class="status info">Unread: 0</div>
        <button class="button" onclick="loadNotifications()">Load Notifications</button>
        <button class="button" onclick="markAllAsRead()">Mark All Read</button>
        <div id="notifications"></div>
    </div>

    <div class="container">
        <h2>Test Log</h2>
        <div id="log" class="log"></div>
        <button class="button" onclick="clearLog()">Clear Log</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        const SOCKET_URL = 'http://localhost:5000';
        
        let authToken = '';
        let userId = '';
        let socket = null;
        let preferences = null;

        // Utility functions
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const logEntry = `[${timestamp}] ${message}${data ? '\n' + JSON.stringify(data, null, 2) : ''}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message, data);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Authentication functions
        async function login() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'testpassword123'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Login failed: ${response.statusText}`);
                }

                const data = await response.json();
                authToken = data.token;
                userId = data.user.id;
                
                updateStatus('authStatus', 'Authenticated successfully', 'success');
                log('‚úÖ Login successful', { userId });
                
                // Auto-connect socket after login
                connectSocket();
            } catch (error) {
                updateStatus('authStatus', `Login failed: ${error.message}`, 'error');
                log('‚ùå Login failed', error);
            }
        }

        function logout() {
            authToken = '';
            userId = '';
            updateStatus('authStatus', 'Not authenticated', 'info');
            disconnectSocket();
            log('üëã Logged out');
        }

        // Socket.IO functions
        function connectSocket() {
            if (!authToken) {
                log('‚ùå Cannot connect socket: not authenticated');
                return;
            }

            try {
                socket = io(SOCKET_URL, {
                    auth: { token: authToken },
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    updateStatus('socketStatus', `Connected (${socket.id})`, 'success');
                    log('‚úÖ Socket.IO connected', { socketId: socket.id });
                });

                socket.on('disconnect', () => {
                    updateStatus('socketStatus', 'Disconnected', 'error');
                    log('‚ùå Socket.IO disconnected');
                });

                socket.on('connect_error', (error) => {
                    updateStatus('socketStatus', `Connection error: ${error.message}`, 'error');
                    log('‚ùå Socket.IO connection error', error);
                });

                socket.on('notification', (notification) => {
                    log('üîî Real-time notification received', notification);
                    loadNotifications(); // Refresh notifications
                    loadUnreadCount(); // Refresh unread count
                });

                socket.on('unread_count_update', (data) => {
                    log('üìä Unread count updated', data);
                    updateUnreadCountDisplay(data.count);
                });

                socket.on('auth_error', (error) => {
                    log('‚ùå Socket authentication error', error);
                    logout();
                });

            } catch (error) {
                log('‚ùå Socket connection failed', error);
            }
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus('socketStatus', 'Not connected', 'info');
                log('üîå Socket disconnected');
            }
        }

        // API functions
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            const response = await fetch(url, config);
            
            if (!response.ok) {
                throw new Error(`API call failed: ${response.statusText}`);
            }

            return response.json();
        }

        // Notification functions
        async function sendTestNotification(type, title, message, data = {}) {
            try {
                await apiCall('/test-notifications/test', {
                    method: 'POST',
                    body: JSON.stringify({ type, title, message, data })
                });
                log(`‚úÖ ${type} notification sent`);
            } catch (error) {
                log(`‚ùå Failed to send ${type} notification`, error);
            }
        }

        async function sendBulkNotifications(count) {
            try {
                await apiCall('/test-notifications/test/bulk', {
                    method: 'POST',
                    body: JSON.stringify({ count })
                });
                log(`‚úÖ ${count} bulk notifications sent`);
            } catch (error) {
                log(`‚ùå Failed to send bulk notifications`, error);
            }
        }

        async function loadNotifications() {
            try {
                const data = await apiCall('/notifications?limit=20');
                displayNotifications(data.notifications);
                log('‚úÖ Notifications loaded', { count: data.notifications.length });
            } catch (error) {
                log('‚ùå Failed to load notifications', error);
            }
        }

        function displayNotifications(notifications) {
            const container = document.getElementById('notifications');
            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = '<div class="notification">No notifications</div>';
                return;
            }

            notifications.forEach(notif => {
                const div = document.createElement('div');
                div.className = `notification ${notif.isRead ? '' : 'unread'} ${notif.priority || 'medium'}`;
                
                const icon = getNotificationIcon(notif.type);
                const timeAgo = formatTimeAgo(notif.createdAt);
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;">${icon}</span>
                                <strong>${notif.title}</strong>
                                ${notif.priority === 'high' ? '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">HIGH</span>' : ''}
                            </div>
                            <p style="margin: 5px 0; color: #666;">${notif.message}</p>
                            <small style="color: #999;">${timeAgo}</small>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            ${!notif.isRead ? `<button class="button" onclick="markAsRead('${notif.id}')" style="padding: 5px 10px; font-size: 12px;">Mark Read</button>` : ''}
                            <button class="button" onclick="deleteNotification('${notif.id}')" style="padding: 5px 10px; font-size: 12px; background: #dc3545;">Delete</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function getNotificationIcon(type) {
            const icons = {
                follow: 'üë•',
                like: '‚ù§Ô∏è',
                comment: 'üí¨',
                challenge: 'üèÜ',
                problem: 'üíª',
                achievement: 'üéâ',
                system: 'üì¢'
            };
            return icons[type] || 'üîî';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        async function markAsRead(notificationId) {
            try {
                await apiCall(`/notifications/${notificationId}/read`, { method: 'PUT' });
                log('‚úÖ Notification marked as read');
                loadNotifications();
                loadUnreadCount();
            } catch (error) {
                log('‚ùå Failed to mark notification as read', error);
            }
        }

        async function deleteNotification(notificationId) {
            try {
                await apiCall(`/notifications/${notificationId}`, { method: 'DELETE' });
                log('‚úÖ Notification deleted');
                loadNotifications();
                loadUnreadCount();
            } catch (error) {
                log('‚ùå Failed to delete notification', error);
            }
        }

        async function markAllAsRead() {
            try {
                await apiCall('/notifications/read-all', { method: 'PUT' });
                log('‚úÖ All notifications marked as read');
                loadNotifications();
                loadUnreadCount();
            } catch (error) {
                log('‚ùå Failed to mark all notifications as read', error);
            }
        }

        async function loadUnreadCount() {
            try {
                const data = await apiCall('/notifications/unread-count');
                updateUnreadCountDisplay(data.count);
            } catch (error) {
                log('‚ùå Failed to load unread count', error);
            }
        }

        function updateUnreadCountDisplay(count) {
            const element = document.getElementById('unreadCount');
            element.textContent = `Unread: ${count}`;
            element.className = count > 0 ? 'status error' : 'status success';
        }

        // Preferences functions
        async function loadPreferences() {
            try {
                const data = await apiCall('/notifications/preferences');
                preferences = data.preferences;
                displayPreferences();
                log('‚úÖ Preferences loaded');
            } catch (error) {
                log('‚ùå Failed to load preferences', error);
            }
        }

        function displayPreferences() {
            if (!preferences) return;

            const container = document.getElementById('preferences');
            container.innerHTML = '';

            // Main preferences
            const mainPrefs = [
                { key: 'email', label: 'Email Notifications' },
                { key: 'push', label: 'Push Notifications' },
                { key: 'inApp', label: 'In-App Notifications' }
            ];

            mainPrefs.forEach(pref => {
                const div = document.createElement('div');
                div.className = 'preference-item';
                div.innerHTML = `
                    <span>${pref.label}</span>
                    <label class="toggle">
                        <input type="checkbox" ${preferences[pref.key] ? 'checked' : ''} onchange="updatePreference('${pref.key}', this.checked)">
                        <span class="slider"></span>
                    </label>
                `;
                container.appendChild(div);
            });

            // Notification types
            const typesDiv = document.createElement('div');
            typesDiv.innerHTML = '<h4>Notification Types</h4>';
            container.appendChild(typesDiv);

            Object.entries(preferences.types).forEach(([type, enabled]) => {
                const div = document.createElement('div');
                div.className = 'preference-item';
                div.innerHTML = `
                    <span>${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                    <label class="toggle">
                        <input type="checkbox" ${enabled ? 'checked' : ''} onchange="updatePreferenceType('${type}', this.checked)">
                        <span class="slider"></span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function updatePreference(key, value) {
            if (preferences) {
                preferences[key] = value;
            }
        }

        function updatePreferenceType(type, value) {
            if (preferences && preferences.types) {
                preferences.types[type] = value;
            }
        }

        async function savePreferences() {
            if (!preferences) return;

            try {
                await apiCall('/notifications/preferences', {
                    method: 'PUT',
                    body: JSON.stringify({ preferences })
                });
                log('‚úÖ Preferences saved');
                
                // Send preferences to socket server
                if (socket) {
                    socket.emit('update_notification_preferences', preferences);
                }
            } catch (error) {
                log('‚ùå Failed to save preferences', error);
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Initialize
        log('üöÄ Notification system test page loaded');
        log('‚ÑπÔ∏è Click "Login" to start testing');
    </script>
</body>
</html>
